{% extends "base.html" %}
{% from 'macros.html' import bird_thumbnail %}

{% block title %}File #{{ file.id }} - Birdhomie{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Breadcrumbs -->
    <nav class="flex mb-4" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="/" class="text-gray-700 hover:text-blue-600">
                    <i class="bi bi-house-door mr-1"></i>Home
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="bi bi-chevron-right text-gray-400 mx-2"></i>
                    <a href="/files" class="text-gray-700 hover:text-blue-600">Files</a>
                </div>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <i class="bi bi-chevron-right text-gray-400 mx-2"></i>
                    <span class="text-gray-500">File #{{ file.id }}</span>
                </div>
            </li>
        </ol>
    </nav>

    <!-- Duplicate Warning -->
    {% if file.status == 'ignored' %}
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="bi bi-info-circle text-blue-400 text-xl"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm text-blue-700">
                    {{ _('This file was manually merged') }}
                    {% if file.duplicate_of_file_id %}
                    {{ _('into') }} <a href="/files/{{ file.duplicate_of_file_id }}" class="font-medium underline hover:text-blue-600">{{ _('file') }} #{{ file.duplicate_of_file_id }}</a>
                    {% endif %}.
                    {{ _('The video file is kept on disk but was not processed.') }}
                </p>
                <form method="POST" action="/files/{{ file.id }}/unignore" class="mt-2">
                    <button type="submit" class="text-sm font-medium text-blue-700 hover:text-blue-600 underline">
                        {{ _('Process this file anyway') }}
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- File Header -->
    <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="bi bi-film mr-2"></i>{{ file.file_path.split('/')[-1] }}
            </h1>
            <p class="text-sm text-gray-500">
                <i class="bi bi-calendar3"></i> {{ file.event_start|format_datetime('datetime') }}
            </p>

            <!-- File stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-sm text-gray-500">Duration</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ "%.1f"|format(file.duration_seconds) }}s</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-sm text-gray-500">Species Detected</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ visits|length }}</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-sm text-gray-500">Total Detections</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ detections|length }}</p>
                </div>
            </div>

            <!-- Merge File Action -->
            {% if file.status != 'ignored' %}
            <div class="mt-6 pt-6 border-t border-gray-200">
                <h3 class="text-sm font-medium text-gray-700 mb-2">{{ _('Merge with another file') }}</h3>
                <p class="text-xs text-gray-500 mb-3">{{ _('If this is a duplicate, merge it into another file. This will mark this file as ignored and soft-delete its visits.') }}</p>
                <form method="POST" action="/files/{{ file.id }}/merge" class="flex gap-2" onsubmit="return confirmMerge(event)">
                    <select name="target_id"
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500"
                           required>
                        <option value="">{{ _('Select a file to merge into...') }}</option>
                        {% for available_file in available_files %}
                        <option value="{{ available_file.id }}">
                            #{{ available_file.id }} - {{ available_file.file_path.split('/')[-1] }} ({{ available_file.event_start|format_datetime('datetime') }})
                        </option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
                        <i class="bi bi-arrow-left-right mr-1"></i>{{ _('Merge') }}
                    </button>
                </form>
            </div>
            <script>
            const i18n_merge = {
                selectFile: '{{ _('Please select a target file') }}',
                cannotMergeSelf: '{{ _('Cannot merge a file into itself') }}',
                confirmTemplate: '{{ _('Are you sure you want to merge file #{{current}} into {{target}}? This will mark file #{{current}} as ignored and soft-delete its visits. The file will remain on disk.') }}'
            };

            function confirmMerge(event) {
                const form = event.target;
                const targetId = form.elements['target_id'].value;
                const currentId = {{ file.id }};

                if (!targetId) {
                    alert(i18n_merge.selectFile);
                    return false;
                }

                if (targetId == currentId) {
                    alert(i18n_merge.cannotMergeSelf);
                    return false;
                }

                const selectedOption = form.elements['target_id'].options[form.elements['target_id'].selectedIndex];
                const targetFileName = selectedOption.text;

                const message = i18n_merge.confirmTemplate
                    .replace(/\{\{current\}\}/g, currentId)
                    .replace(/\{\{target\}\}/g, targetFileName);

                return confirm(message);
            }
            </script>
            {% endif %}
        </div>
    </div>

    <!-- Annotated Video Player -->
    {% if is_video %}
    <div class="mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">
            <i class="bi bi-play-circle"></i> Annotated Video
        </h2>
        <div class="bg-white shadow overflow-hidden sm:rounded-lg p-4">
            {% if video_available %}
            <video controls class="w-full max-w-4xl rounded-lg shadow-lg">
                <source src="/data/{{ annotated_path }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            {% elif file_status == 'processing' %}
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center">
                    <i class="bi bi-hourglass-split text-blue-600 text-2xl mr-3"></i>
                    <div>
                        <p class="text-blue-900 font-medium">{{ _('Video is being processed') }}</p>
                        <p class="text-blue-700 text-sm">{{ _('The annotated video will be available once processing is complete.') }}</p>
                    </div>
                </div>
            </div>
            {% elif file_status == 'failed' %}
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-center">
                    <i class="bi bi-exclamation-triangle text-red-600 text-2xl mr-3"></i>
                    <div>
                        <p class="text-red-900 font-medium">{{ _('Video processing failed') }}</p>
                        <p class="text-red-700 text-sm">{{ _('There was an error processing this video file.') }}</p>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-center">
                    <i class="bi bi-exclamation-circle text-yellow-600 text-2xl mr-3"></i>
                    <div>
                        <p class="text-yellow-900 font-medium">{{ _('Video not available') }}</p>
                        <p class="text-yellow-700 text-sm">{{ _('The annotated video file could not be found.') }}</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Species Summary -->
    {% if visits %}
    <div class="mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">
            <i class="bi bi-grid-3x3-gap"></i> Species in this File
        </h2>
        <div class="bg-white shadow overflow-hidden sm:rounded-md">
            <ul class="divide-y divide-gray-200">
                {% for visit in visits %}
                <li class="px-4 py-3 hover:bg-gray-50 transition-colors">
                    <a href="/visits/{{ visit.id }}" class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-900">{{ visit.species_name }}</p>
                            <p class="text-xs text-gray-500 italic">{{ visit.scientific_name }}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-xs text-gray-500">{{ visit.detection_count }} detections</span>
                            <span class="text-xs text-gray-500">{{ "%.1f"|format(visit.species_confidence * 100) }}%</span>
                            <i class="bi bi-chevron-right text-gray-400"></i>
                        </div>
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <!-- All Detection Crops Grid -->
    <div>
        <h2 class="text-xl font-semibold text-gray-900 mb-3">
            <i class="bi bi-grid-3x2"></i> All Detection Crops ({{ detections|length }})
        </h2>

        {% if detections %}
        <div class="bg-white shadow overflow-hidden sm:rounded-lg p-4">
            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-3">
                {% for detection in detections %}
                <div class="relative group cursor-pointer rounded-lg {% if detection.display_detection_id == detection.detection_id %}ring-2 ring-yellow-400{% endif %}"
                     onclick="openLightbox({{ loop.index0 }})">
                    {{ bird_thumbnail(detection.detection_id, 96, 'w-full h-24 rounded-lg shadow hover:shadow-lg transition-shadow', 'Frame ' ~ detection.frame_number, cache_key=detection.cache_key) }}

                    <!-- Cover/Best badge -->
                    {% if detection.display_detection_id == detection.detection_id %}
                    <span class="absolute top-1 right-1 bg-yellow-400 text-yellow-900 rounded-full p-1 w-5 h-5 flex items-center justify-center">
                        <i class="bi bi-star-fill text-xs"></i>
                    </span>
                    {% endif %}

                    <!-- Frame number -->
                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-75 text-white text-xs p-1 rounded-b-lg text-center">
                        {{ detection.frame_number }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <p class="text-gray-500">No detection crops available.</p>
        {% endif %}
    </div>
</div>

<!-- Lightbox Modal -->
<div id="lightbox" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50" onclick="closeLightbox()">
    <div class="h-full w-full flex flex-col items-center justify-center p-8" onclick="event.stopPropagation()">
        <button onclick="closeLightbox()" class="absolute top-4 right-4 text-white hover:text-gray-300 text-3xl font-bold z-10">
            <i class="bi bi-x-circle-fill"></i>
        </button>

        <!-- Navigation arrows -->
        <button id="lightbox-prev" onclick="navigateLightbox(-1)" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 text-5xl z-10">
            <i class="bi bi-chevron-left"></i>
        </button>
        <button id="lightbox-next" onclick="navigateLightbox(1)" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 text-5xl z-10">
            <i class="bi bi-chevron-right"></i>
        </button>

        <div class="relative flex items-center justify-center mb-4" style="width: 90vw; height: 75vh;">
            <img id="lightbox-image" src="" alt="Detection" class="w-full h-full rounded-lg object-contain">
        </div>

        <!-- Info bar -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 bg-white bg-opacity-10 backdrop-blur-sm rounded-lg p-4 max-w-5xl w-full">
            <div class="text-white text-sm">
                <p id="lightbox-caption" class="font-semibold mb-1"></p>
                <p id="lightbox-counter" class="text-gray-400 text-xs mt-1"></p>
            </div>
            <a id="lightbox-visit-link" href="#" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium">
                <i class="bi bi-arrow-right-circle mr-2"></i>Go to Visit
            </a>
        </div>
    </div>
</div>

<script>
const detectionsData = [
    {% for detection in detections %}
    {
        imagePath: '/data/output/{{ detection.crop_path }}',
        frameNumber: {{ detection.frame_number }},
        frameTimestamp: {{ "%.1f"|format(detection.frame_timestamp) }},
        detectionId: {{ detection.detection_id }},
        visitId: {{ detection.visit_id }},
        confidence: {% if detection.detection_confidence %}{{ "%.0f"|format(detection.detection_confidence * 100) }}{% else %}null{% endif %}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

let currentLightboxIndex = 0;

function openLightbox(index) {
    currentLightboxIndex = index;
    showLightboxImage(index);
}

function showLightboxImage(index) {
    const detection = detectionsData[index];
    const lightbox = document.getElementById('lightbox');
    const image = document.getElementById('lightbox-image');
    const caption = document.getElementById('lightbox-caption');
    const counter = document.getElementById('lightbox-counter');
    const visitLink = document.getElementById('lightbox-visit-link');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');

    image.src = detection.imagePath;
    const confidenceText = detection.confidence !== null ? ` - Confidence: ${detection.confidence}%` : '';
    caption.textContent = `Frame ${detection.frameNumber} - ${detection.frameTimestamp}s${confidenceText}`;
    counter.textContent = `${index + 1} / ${detectionsData.length}`;
    visitLink.href = `/visits/${detection.visitId}`;

    prevBtn.style.display = index > 0 ? 'block' : 'none';
    nextBtn.style.display = index < detectionsData.length - 1 ? 'block' : 'none';

    lightbox.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function navigateLightbox(direction) {
    const newIndex = currentLightboxIndex + direction;
    if (newIndex >= 0 && newIndex < detectionsData.length) {
        currentLightboxIndex = newIndex;
        showLightboxImage(currentLightboxIndex);
    }
}

function closeLightbox() {
    const lightbox = document.getElementById('lightbox');
    lightbox.classList.add('hidden');
    document.body.style.overflow = 'auto';
}

// Keyboard controls
document.addEventListener('keydown', function(event) {
    const lightbox = document.getElementById('lightbox');
    if (lightbox.classList.contains('hidden')) return;

    if (event.key === 'Escape') {
        closeLightbox();
    } else if (event.key === 'ArrowLeft') {
        navigateLightbox(-1);
    } else if (event.key === 'ArrowRight') {
        navigateLightbox(1);
    }
});
</script>
{% endblock %}
