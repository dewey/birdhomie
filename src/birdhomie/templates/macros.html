{# Reusable bird thumbnail component with cache busting #}
{% macro bird_thumbnail(detection_id, size=96, css_class='', alt='Bird detection', cache_key=None) %}
{%- set url = '/thumbnail/' ~ detection_id ~ '/' ~ size -%}
{%- if cache_key -%}
{%- set url = url ~ '?v=' ~ (cache_key | string | replace(' ', 'T') | replace(':', '') | replace('-', '')) -%}
{%- endif -%}
<img src="{{ url }}"
     alt="{{ alt }}"
     class="object-cover {{ css_class }}"
     loading="lazy">
{% endmacro %}

{# Thumbnail card with common styling and optional badge #}
{% macro bird_thumbnail_card(detection_id, size=96, show_badge=false, badge_icon='star-fill', cache_key=None) %}
<div class="relative group">
    {{ bird_thumbnail(detection_id, size,
                     'w-24 h-24 rounded-lg shadow-md group-hover:shadow-xl transition-shadow border-2 border-gray-200 group-hover:border-yellow-400',
                     cache_key=cache_key) }}
    {% if show_badge %}
    <div class="absolute -bottom-1 -right-1 bg-yellow-400 text-yellow-900 rounded-full p-1.5 w-6 h-6 flex items-center justify-center">
        <i class="bi bi-{{ badge_icon }} text-xs"></i>
    </div>
    {% endif %}
</div>
{% endmacro %}

{# Shared pagination component #}
{% macro pagination(page, total_pages, base_url) %}
{% if total_pages > 1 %}
<nav class="flex items-center justify-between border-t border-gray-200 px-4 sm:px-0 mt-6">
    <div class="flex w-0 flex-1 -mt-px">
        {% if page > 1 %}
        <a href="{{ base_url }}?page={{ page - 1 }}" class="inline-flex items-center border-t-2 border-transparent pt-4 pr-1 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
            <i class="bi bi-arrow-left mr-3 text-gray-400"></i>
            Previous
        </a>
        {% endif %}
    </div>
    <div class="hidden md:flex -mt-px">
        {% set start_page = [1, page - 2] | max %}
        {% set end_page = [total_pages, page + 2] | min %}

        {% if start_page > 1 %}
        <a href="{{ base_url }}?page=1" class="inline-flex items-center border-t-2 border-transparent px-4 pt-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">1</a>
        {% if start_page > 2 %}
        <span class="inline-flex items-center border-t-2 border-transparent px-4 pt-4 text-sm font-medium text-gray-500">...</span>
        {% endif %}
        {% endif %}

        {% for p in range(start_page, end_page + 1) %}
        <a href="{{ base_url }}?page={{ p }}" class="inline-flex items-center border-t-2 {% if p == page %}border-blue-500 text-blue-600{% else %}border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700{% endif %} px-4 pt-4 text-sm font-medium">{{ p }}</a>
        {% endfor %}

        {% if end_page < total_pages %}
        {% if end_page < total_pages - 1 %}
        <span class="inline-flex items-center border-t-2 border-transparent px-4 pt-4 text-sm font-medium text-gray-500">...</span>
        {% endif %}
        <a href="{{ base_url }}?page={{ total_pages }}" class="inline-flex items-center border-t-2 border-transparent px-4 pt-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">{{ total_pages }}</a>
        {% endif %}
    </div>
    <div class="flex w-0 flex-1 justify-end -mt-px">
        {% if page < total_pages %}
        <a href="{{ base_url }}?page={{ page + 1 }}" class="inline-flex items-center border-t-2 border-transparent pt-4 pl-1 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
            Next
            <i class="bi bi-arrow-right ml-3 text-gray-400"></i>
        </a>
        {% endif %}
    </div>
</nav>
<div class="text-center text-sm text-gray-500 mt-2">
    Page {{ page }} of {{ total_pages }}
</div>
{% endif %}
{% endmacro %}

{# Status overview with pie chart #}
{# Color mapping: success=green, error/failed=red, running/processing=blue, pending/queued=orange, unknown=gray #}
{% macro status_overview(status_counts, chart_id) %}
{% set color_map = {
    'success': '#10B981',
    'failed': '#EF4444',
    'error': '#EF4444',
    'running': '#3B82F6',
    'processing': '#3B82F6',
    'pending': '#F59E0B',
    'queued': '#F59E0B',
    'downloading': '#F59E0B',
    'ignored': '#6B7280',
    'unknown': '#6B7280'
} %}
{% set default_color = '#6B7280' %}
<div class="bg-white shadow rounded-lg mb-6">
    <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Overview</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="flex justify-center">
                <div style="max-width: 200px; max-height: 200px;">
                    <canvas id="{{ chart_id }}"></canvas>
                </div>
            </div>
            <div class="flex flex-col justify-center space-y-2">
                {% for status, count in status_counts.items() %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="w-3 h-3 rounded-full mr-2" style="background-color: {{ color_map.get(status, default_color) }};"></span>
                        <span class="text-sm text-gray-600 capitalize">{{ status }}</span>
                    </div>
                    <span class="text-sm font-medium text-gray-900">{{ count }}</span>
                </div>
                {% endfor %}
                <div class="border-t pt-2 mt-2">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-600">Total</span>
                        <span class="text-sm font-bold text-gray-900">{{ status_counts.values() | sum }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endmacro %}
