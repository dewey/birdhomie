{% extends "base.html" %}
{% from 'macros.html' import bird_thumbnail %}

{% block title %}Visit #{{ visit.id }} - {{ visit.species_name }} - Birdhomie{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Breadcrumbs -->
    <nav class="flex mb-4" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="/" class="text-gray-700 hover:text-blue-600">
                    <i class="bi bi-house-door mr-1"></i>Home
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="bi bi-chevron-right text-gray-400 mx-2"></i>
                    <a href="/species" class="text-gray-700 hover:text-blue-600">Species</a>
                </div>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="bi bi-chevron-right text-gray-400 mx-2"></i>
                    <a href="/species/{{ visit.taxon_id }}" class="text-gray-700 hover:text-blue-600">{{ visit.species_name }}</a>
                </div>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <i class="bi bi-chevron-right text-gray-400 mx-2"></i>
                    <span class="text-gray-500">Visit #{{ visit.id }}</span>
                </div>
            </li>
        </ol>
    </nav>

    <!-- Main Content -->
    <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">{{ visit.species_name }}</h1>
                    <p class="text-lg text-gray-500 italic">{{ visit.scientific_name }}</p>
                    <p class="text-sm text-gray-500 mt-2">
                        <i class="bi bi-calendar3"></i> {{ visit.event_start|format_datetime('datetime') }}
                    </p>
                </div>
                {% if visit.corrected_at %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                    <i class="bi bi-pencil-square mr-1"></i> Corrected
                </span>
                {% endif %}
            </div>

            <!-- Detection Info -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-sm text-gray-500">Detections</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ visit.detection_count }}</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-sm text-gray-500">Species Confidence</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ "%.1f"|format(visit.species_confidence * 100) }}%</p>
                    {% if visit.species_confidence_model %}
                    <p class="text-xs text-gray-500">{{ visit.species_confidence_model }}</p>
                    {% endif %}
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-sm text-gray-500">Duration</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ "%.1f"|format(visit.duration_seconds) }}s</p>
                </div>
            </div>

            <!-- Video/Image Player -->
            {% if is_video and annotated_path %}
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-3">
                    <i class="bi bi-play-circle"></i> Annotated Video
                </h2>
                <video controls class="w-full max-w-4xl rounded-lg shadow-lg">
                    <source src="/data/{{ annotated_path }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
            {% endif %}

            <!-- Species Correction Form -->
            <div class="border-t border-gray-200 pt-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-3">
                    <i class="bi bi-pencil-square"></i> Correct Species Identification
                </h2>

                <!-- Existing species dropdown -->
                <form action="/visits/{{ visit.id }}/correct" method="POST" class="max-w-3xl">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Select from known species
                        </label>
                        <div class="flex gap-3">
                            <select name="taxon_id" class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <option value="">Select correct species...</option>
                                {% for species in all_species %}
                                <option value="{{ species.taxon_id }}" {% if species.taxon_id == visit.taxon_id %}selected{% endif %}>
                                    {{ species.name }} ({{ species.scientific_name }})
                                </option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="inline-flex items-center px-5 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 whitespace-nowrap">
                                <i class="bi bi-check-lg mr-1"></i> Update
                            </button>
                        </div>
                    </div>

                    <!-- OR divider -->
                    <div class="relative mb-6">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-3 bg-white text-gray-500 font-medium">OR</span>
                        </div>
                    </div>

                    <!-- iNaturalist URL input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Paste iNaturalist link for new species
                        </label>
                        <div class="flex gap-3">
                            <input type="url"
                                   name="inaturalist_url"
                                   placeholder="https://www.inaturalist.org/taxa/13094"
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white"
                                   pattern="https://.*inaturalist\.org/taxa/[0-9]+.*">
                            <button type="submit" class="inline-flex items-center px-5 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 whitespace-nowrap">
                                <i class="bi bi-plus-circle mr-1"></i> Add & Update
                            </button>
                        </div>
                        <p class="mt-2 text-sm text-gray-500">
                            <i class="bi bi-info-circle mr-1"></i> Example: https://www.inaturalist.org/taxa/13094
                        </p>
                    </div>
                </form>
            </div>

            <!-- Detection Crops -->
            <div class="border-t border-gray-200 pt-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-3">
                    <i class="bi bi-grid-3x2"></i> All Detections ({{ detections|length }})
                </h2>

                {% if detections %}
                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-8 gap-4">
                    {% for detection in detections %}
                    <div class="relative group cursor-pointer rounded-lg {% if visit.cover_detection_id == detection.id %}ring-4 ring-yellow-400{% endif %}" onclick="openLightbox('/data/output/{{ detection.crop_path }}', '{{ visit.event_start|format_datetime('datetime', False) }}', {{ visit.id }}, {{ detection.id }}, '{{ detection.annotation_source or '' }}', 'Frame {{ detection.frame_number }} - {{ "%.1f"|format(detection.frame_timestamp) }}s - Confidence: {{ "%.0f"|format(detection.detection_confidence * 100) if detection.detection_confidence else "N/A" }}%')">
                        {{ bird_thumbnail(detection.id, 128, 'w-full h-40 rounded-lg shadow hover:shadow-lg transition-shadow', 'Frame ' ~ detection.frame_number, cache_key=detection.frame_timestamp) }}

                        <!-- Cover image badge (yellow star) -->
                        {% if visit.cover_detection_id == detection.id %}
                        <span class="absolute top-2 right-2 bg-yellow-400 text-yellow-900 rounded-full p-1.5 w-6 h-6 flex items-center justify-center" title="Cover Image">
                            <i class="bi bi-star-fill text-xs"></i>
                        </span>
                        {% endif %}

                        <!-- Frame number overlay -->
                        <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-75 text-white text-xs p-2 rounded-b-lg">
                            <div class="flex justify-between items-center">
                                <span><i class="bi bi-film"></i> Frame {{ detection.frame_number }}</span>
                                {% if detection.detection_confidence %}
                                <span>{{ "%.0f"|format(detection.detection_confidence * 100) }}%</span>
                                {% endif %}
                            </div>
                            {% if detection.frame_timestamp %}
                            <div class="text-gray-300">{{ "%.1f"|format(detection.frame_timestamp) }}s</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500">No detection crops available.</p>
                {% endif %}
            </div>

            <!-- File Link -->
            <div class="border-t border-gray-200 pt-6 mt-6">
                <a href="/files/{{ visit.file_id }}" class="inline-flex items-center text-blue-600 hover:text-blue-800">
                    <i class="bi bi-file-earmark-text mr-1"></i> View source file
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Lightbox Modal -->
<div id="lightbox" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50" onclick="closeLightbox()">
    <div class="h-full w-full flex flex-col items-center justify-center p-8" onclick="event.stopPropagation()">
        <!-- Close button -->
        <button onclick="closeLightbox()" class="absolute top-4 right-4 text-white hover:text-gray-300 text-3xl font-bold z-10">
            <i class="bi bi-x-circle-fill"></i>
        </button>

        <!-- Previous button -->
        <button id="lightbox-prev" onclick="navigateLightbox(-1)" class="absolute left-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 text-5xl z-10 bg-black bg-opacity-50 rounded-full w-14 h-14 flex items-center justify-center">
            <i class="bi bi-chevron-left"></i>
        </button>

        <!-- Next button -->
        <button id="lightbox-next" onclick="navigateLightbox(1)" class="absolute right-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 text-5xl z-10 bg-black bg-opacity-50 rounded-full w-14 h-14 flex items-center justify-center">
            <i class="bi bi-chevron-right"></i>
        </button>

        <!-- Fixed size image container -->
        <div class="relative flex items-center justify-center mb-4" style="width: 90vw; height: 75vh; max-width: 1400px;">
            <img id="lightbox-image" src="" alt="Full size detection" class="w-full h-full rounded-lg object-contain">
        </div>

        <!-- Info bar -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 bg-white bg-opacity-10 backdrop-blur-sm rounded-lg p-4 max-w-5xl w-full">
            <div class="text-white text-sm">
                <p id="lightbox-caption" class="font-semibold mb-1"></p>
                <p id="lightbox-details" class="text-gray-300 text-xs"></p>
                <p id="lightbox-counter" class="text-gray-400 text-xs mt-1"></p>
            </div>
            <div class="flex gap-2 flex-shrink-0">
                <a id="lightbox-label-link" href="#" class="inline-flex items-center px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-md text-sm font-medium transition-colors">
                    <i class="bi bi-pencil-square mr-2"></i><span id="lightbox-label-text">Label face</span>
                </a>
                <button id="lightbox-cover-btn" onclick="setCoverImage()" class="inline-flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md text-sm font-medium transition-colors">
                    <i class="bi bi-image mr-2"></i><span id="lightbox-cover-text">Set as Cover</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Detections data array
const detectionsData = [
    {% for detection in detections %}
    {
        imagePath: '/data/output/{{ detection.crop_path }}',
        eventStart: '{{ visit.event_start|format_datetime('datetime', False) }}',
        visitId: {{ visit.id }},
        detectionId: {{ detection.id }},
        annotationSource: '{{ detection.annotation_source or '' }}',
        detailsText: 'Frame {{ detection.frame_number }} - {{ "%.1f"|format(detection.frame_timestamp) }}s - Confidence: {{ "%.0f"|format(detection.detection_confidence * 100) if detection.detection_confidence else "N/A" }}%',
        isCover: {% if visit.cover_detection_id == detection.id %}true{% else %}false{% endif %}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

let currentLightboxIndex = 0;

function openLightbox(imagePath, eventStart, visitId, detectionId, annotationSource, detailsText) {
    // Find the index of this detection
    currentLightboxIndex = detectionsData.findIndex(d => d.detectionId === detectionId);
    if (currentLightboxIndex === -1) currentLightboxIndex = 0;

    showLightboxImage(currentLightboxIndex);
}

function showLightboxImage(index) {
    const detection = detectionsData[index];
    const lightbox = document.getElementById('lightbox');
    const image = document.getElementById('lightbox-image');
    const caption = document.getElementById('lightbox-caption');
    const details = document.getElementById('lightbox-details');
    const counter = document.getElementById('lightbox-counter');
    const labelLink = document.getElementById('lightbox-label-link');
    const labelText = document.getElementById('lightbox-label-text');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');

    // Update image and content
    image.src = detection.imagePath;
    caption.textContent = `Detection from ${detection.eventStart}`;
    details.textContent = detection.detailsText;
    counter.textContent = `${index + 1} / ${detectionsData.length}`;

    // Determine if this is a relabel based on annotation source
    const isHumanLabeled = detection.annotationSource === 'human_confirmed' || detection.annotationSource === 'human_corrected';
    labelText.textContent = isHumanLabeled ? 'Re-label face' : 'Label face';

    // Add return URL to redirect back to lightbox after labeling
    const currentUrl = encodeURIComponent(window.location.pathname + `#detection-${detection.detectionId}`);
    labelLink.href = `/labeling?id=${detection.detectionId}&return_url=${currentUrl}`;

    // Update cover button text and style based on whether this detection is the cover
    const coverBtn = document.getElementById('lightbox-cover-btn');
    const coverText = document.getElementById('lightbox-cover-text');

    if (detection.isCover) {
        coverText.textContent = 'Cover Image (Active)';
        coverBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
        coverBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
    } else {
        coverText.textContent = 'Set as Cover';
        coverBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
        coverBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
    }

    // Show/hide navigation buttons
    prevBtn.style.display = index > 0 ? 'block' : 'none';
    nextBtn.style.display = index < detectionsData.length - 1 ? 'block' : 'none';

    lightbox.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function navigateLightbox(direction) {
    const newIndex = currentLightboxIndex + direction;
    if (newIndex >= 0 && newIndex < detectionsData.length) {
        currentLightboxIndex = newIndex;
        showLightboxImage(currentLightboxIndex);
    }
}

function closeLightbox() {
    const lightbox = document.getElementById('lightbox');
    lightbox.classList.add('hidden');
    document.body.style.overflow = 'auto';
}

async function setCoverImage() {
    const detection = detectionsData[currentLightboxIndex];

    try {
        const response = await fetch(`/api/visits/${detection.visitId}/set-cover/${detection.detectionId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });

        if (!response.ok) throw new Error('Failed to set cover');

        const data = await response.json();
        if (data.success) {
            window.location.reload();
        }
    } catch (error) {
        console.error('Error setting cover:', error);
        alert('Failed to set cover image. Please try again.');
    }
}

// Keyboard controls
document.addEventListener('keydown', function(event) {
    const lightbox = document.getElementById('lightbox');
    if (lightbox.classList.contains('hidden')) return;

    if (event.key === 'Escape') {
        closeLightbox();
    } else if (event.key === 'ArrowLeft') {
        event.preventDefault();
        navigateLightbox(-1);
    } else if (event.key === 'ArrowRight') {
        event.preventDefault();
        navigateLightbox(1);
    }
});

// Auto-open lightbox if returning from labeling with detection ID in hash
document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    if (hash.startsWith('#detection-')) {
        const detectionId = parseInt(hash.replace('#detection-', ''));
        const index = detectionsData.findIndex(d => d.detectionId === detectionId);
        if (index !== -1) {
            currentLightboxIndex = index;
            showLightboxImage(currentLightboxIndex);
        }
    }
});

// Clear other field when one is selected
document.addEventListener('DOMContentLoaded', function() {
    const dropdownSelect = document.querySelector('select[name="taxon_id"]');
    const urlInput = document.querySelector('input[name="inaturalist_url"]');

    if (dropdownSelect && urlInput) {
        dropdownSelect.addEventListener('change', function() {
            if (this.value) {
                urlInput.value = '';
            }
        });

        urlInput.addEventListener('input', function() {
            if (this.value) {
                dropdownSelect.value = '';
            }
        });
    }
});
</script>
{% endblock %}
